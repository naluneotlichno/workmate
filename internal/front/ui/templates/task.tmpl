{{define "task"}}
  {{template "layout_task" .}}
{{end}}

{{define "layout_task"}}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Workmate UI · Task</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;max-width:880px;margin:32px auto;padding:0 16px;color:#0b0b0b;background:#fafafa}
    header{margin-bottom:24px}
    h1{font-size:22px;margin:0 0 8px}
    a{color:#0b63e5;text-decoration:none}
    a:hover{text-decoration:underline}
    .card{background:#fff;border:1px solid #e9e9e9;border-radius:10px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-block;background:#0b63e5;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#444}
    input[type=text]{padding:9px 10px;border:1px solid #dcdcdc;border-radius:8px;width:100%}
    .muted{color:#666}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .list{margin:0;padding-left:18px}
    .status{display:inline-block;padding:4px 8px;border-radius:6px;background:#efefef;font-size:12px}
    footer{margin-top:24px;color:#666;font-size:12px}
  </style>
  </head>
<body>
  <header>
    <h1><a href="/">Workmate UI</a></h1>
    <div class="muted">Minimal no-JS helper for API</div>
  </header>
  {{template "content-task" .}}
  <footer>
    <div>API base: <span class="mono">/api/v1</span></div>
  </footer>
 </body>
</html>
{{end}}

{{define "content-task"}}
  {{if .Error}}
  <div class="card" style="border-color:#f2b8b5;background:#fff6f6">
    <strong style="color:#b3261e">Error:</strong> <span class="muted">{{.Error}}</span>
  </div>
  {{end}}
  <div class="card">
    <h2>Task <span class="mono" id="taskId">{{.Task.ID}}</span></h2>
    {{if .Task.Title}}
    <div>Title: <strong id="taskTitle">{{.Task.Title}}</strong></div>
    {{end}}
    <div>Status: <span class="status" id="taskStatus">{{.Task.Status}}</span></div>
    <div class="muted">Created at: <span id="taskCreatedAt">{{.Task.CreatedAt}}</span></div>
  </div>

  <div class="card">
    <h3>Files</h3>
    <ul class="list" id="filesList">
      {{if .Task.Files}}
        {{range .Task.Files}}
          <li>
            <div><span class="mono">{{.URL}}</span></div>
            <div class="muted">{{.State}}{{if .Filename}} · {{.Filename}}{{end}}{{if .Error}} · error: {{.Error}}{{end}}</div>
          </li>
        {{end}}
      {{end}}
    </ul>
    {{if not .Task.Files}}
      <div class="muted" id="noFilesHint">No files yet</div>
    {{end}}
  </div>

  <div class="card">
    <h3>Add up to 3 URLs (.pdf, .jpeg)</h3>
    <form method="post" action="/ui/tasks/{{.Task.ID}}/files">
      <div class="grid">
        <input type="text" name="urls" placeholder="https://host/a.pdf" />
        <input type="text" name="urls" placeholder="https://host/b.jpeg" />
        <input type="text" name="urls" placeholder="https://host/c.pdf" />
      </div>
      <div style="margin-top:12px"><button class="btn" type="submit">Add</button>
        <a class="btn secondary" href="/ui/tasks/{{.Task.ID}}" style="margin-left:8px">Refresh</a>
      </div>
    </form>
    <div class="muted">POST /api/v1/tasks/{{.Task.ID}}/files</div>
  </div>

  <div class="card">
    <h3>Archive</h3>
    <div>
      <a class="btn" id="downloadBtn" href="/api/v1/tasks/{{.Task.ID}}/archive">Download zip</a>
      <span class="muted" style="margin-left:8px">Link works when status is ready</span>
    </div>
    <div class="muted">GET /api/v1/tasks/{{.Task.ID}}/archive</div>
  </div>

  <script>
  (function() {
    const taskId = document.getElementById('taskId').textContent;
    const statusEl = document.getElementById('taskStatus');
    const titleEl = document.getElementById('taskTitle');
    const createdAtEl = document.getElementById('taskCreatedAt');
    const filesListEl = document.getElementById('filesList');
    const noFilesHintEl = document.getElementById('noFilesHint');
    const downloadBtn = document.getElementById('downloadBtn');

    function setDownloadEnabled(enabled) {
      if (!downloadBtn) return;
      if (enabled) {
        downloadBtn.style.pointerEvents = 'auto';
        downloadBtn.style.opacity = '1';
        downloadBtn.setAttribute('aria-disabled', 'false');
      } else {
        downloadBtn.style.pointerEvents = 'none';
        downloadBtn.style.opacity = '0.6';
        downloadBtn.setAttribute('aria-disabled', 'true');
      }
    }

    async function refreshTask() {
      try {
        const res = await fetch('/api/v1/tasks/' + encodeURIComponent(taskId), { headers: { 'Accept': 'application/json' } });
        if (res.status === 404) {
          if (statusEl) statusEl.textContent = 'not found';
          setDownloadEnabled(false);
          clearInterval(timerId);
          return;
        }
        if (!res.ok) return;
        const data = await res.json();

        if (data.status && statusEl) statusEl.textContent = data.status;
        if (data.title && titleEl) titleEl.textContent = data.title;
        if (data.created_at && createdAtEl) createdAtEl.textContent = data.created_at;

        if (Array.isArray(data.files) && filesListEl) {
          filesListEl.innerHTML = '';
          if (data.files.length === 0 && noFilesHintEl) {
            noFilesHintEl.style.display = 'block';
          } else if (noFilesHintEl) {
            noFilesHintEl.style.display = 'none';
          }
          for (const f of data.files) {
            const li = document.createElement('li');
            const urlDiv = document.createElement('div');
            urlDiv.innerHTML = '<span class="mono"></span>';
            urlDiv.querySelector('span').textContent = f.url || '';
            const metaDiv = document.createElement('div');
            metaDiv.className = 'muted';
            const parts = [f.state || '']
            if (f.filename) parts.push('· ' + f.filename);
            if (f.error) parts.push('· error: ' + f.error);
            metaDiv.textContent = parts.join(' ');
            li.appendChild(urlDiv);
            li.appendChild(metaDiv);
            filesListEl.appendChild(li);
          }
        }

        const ready = data.status === 'ready' && !!data.archive_url;
        setDownloadEnabled(ready);

        if (data.status === 'ready' || data.status === 'failed') {
          clearInterval(timerId);
        }
      } catch (_) {}
    }

    setDownloadEnabled(false);
    let timerId = setInterval(refreshTask, 2000);
    refreshTask();
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        if (timerId) { clearInterval(timerId); timerId = null; }
      } else {
        if (!timerId) {
          refreshTask();
          timerId = setInterval(refreshTask, 2000);
        }
      }
    });
  })();
  </script>
{{end}}


